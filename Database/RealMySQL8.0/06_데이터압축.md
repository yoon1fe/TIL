MySQL 서버에서 파일의 크기는 쿼리 성능 뿐만 아니라 백업, 복구 시간과도 밀접한 연관이 있다. 파일 크기가 클수록 쿼리를 처리하기 위해  더 많은 데이터 페이지를 InnoDB 버퍼 풀로 읽어야 하고, 백업이 오래 걸리고, 복구하는데 오래 걸리기 때문이다. 이러한 문제점을 해결하기 위해 데이터 압축 기능을 제공하는데, MySQL 서버에서는 크게 테이블 압축과 페이지 압축 두 방식을 제공한다.



## 6.1 페이지 압축

페이지 압축은 Transparent Page Compression이라고도 불리는데, MySQL 서버가 디스크에 저장하는 시점에 데이터 페이지가 압축되어 저장되고, 반대로 MySQL 서버가 디스크에서 데이터 페이지를 읽어올 때 압축이 해제되기 때문이다. 따라서 InnoDB 스토리지 엔진은 항상 압축이 해제된 상태로만 데이터 페이지를 관리한다.

페이지 압축 기능은 운영체제별로 특정 버전의 파일 시스템에서만 지원되는 펀치홀이라는 기능이 있다. MySQL 서버는 특정 테이블에 대해 16KB 크기의 페이지를 유지하면서도 압축된 다양한 크기의 데이터 페이지를 디스크에 저장하고 압춘된 만큼의 공간을 절약할 수 있다.

다만 이 기능은 하드웨어 자체에서도 지원해야 사용 가능하고, 파일 시스템 관련 명령어가 펀치 홀을 지원하지 않기 때문에 페이지 압축은 많이 사용하지 않는다.



## 6.2 테이블 압축

테이블 압축은 페이지 압축과 달리 운영체제나 하드웨어에 대한 제약 없이 사용 가능하기 때문에 활용도가 높다. 테이블 단점은 다음과 같다.

- 버퍼 풀 공간 활용률이 낮음
- 쿼리 처리 성능이 낮음
- 빈번한 데이터 변경 시 압축률이 떨어짐



### 압축 테이블 생성

테이블 압축을 하려면 압축하려는 테이블이 별도의 테이블 스페이스를 사용해야 한다. 이를 위해서는 `innodb_file_per_table` 시스템 변수가 `ON`으로 설정된 상태에서 테이블을 생성해야 한다. 추가로 `ROW_FORMAT=COMPRESSED` 옵션과 `KEY_BLOCK_SIZE` 옵션을 명시해야 한다. `KEY_BLOCK_SIZE` 는 압축된 페이지의 목표 크기를 의미하는데, 2n 으로만 설정할 수 있다. InnoDB 스토리지 엔진의 페이지 크기(`innodb_page_size`)가 16KB라면 `KEY_BLOCK_SIZE`는 4/8KB로만 설정할 수 있다. 그리고 페이지 크기가 32/64KB의 경우에는 테이블 압축을 적용할 수 없다.



### KEY_BLOCK_SIZE 결정

테이블 압축에서 가장 중요한 부분은 압축된 결과를 예측해서 `KEY_BLOCK_SIZE`를 결정하는 것이다. 그래서 샘플 데이터를 통해 테스트해보는 것이 좋다. 참고로 압축 실패율이 높다고 해서 압축을 사용하지 말아야 하는 것은 안다. 반대로 압축 실패율이 높지 않은 경우라도 빈번하게 조회되고 변경되는 데이터라면 압축은 고려하지 않는 것이 좋다.



### 압축된 페이지의 버퍼 풀 적재 및 사용

InnoDB 스토리지 엔진은 압축된 테이블의 데이터 페이지를 버퍼 풀에 적재하면 압축된 상태와 해제된 상태 두 가지 버전을 관리한다. 따라서 두 상태에 대한 LRU 리스트를 별도로 관리한다.