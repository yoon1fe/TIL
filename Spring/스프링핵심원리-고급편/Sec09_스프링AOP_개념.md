## 스프링 AOP

### 핵심 기능과 부가 기능

핵심 기능: 해당 객체가 제공하는 고유의 기능.

부가 기능: 핵심 기능을 보조하기 위해 제공되는 기능. 로그 추적, 트랜잭션 기능 등.. 단독으로 사용되지 않음

부가 기능은 보통 여러 클래스에 걸쳐서 함께 사용된다. -> 횡단 관심사(cross cutting concerns)



**부가 기능 적용 문제**

- 여러 클래스에 적용해야 할 경우 많은 반복 필요
- 중복 코드
- 변경할 때 많은 수정 필요



소프트웨어 개발에서 변경 지점은 하나가 될 수 있도록 모듈화가 잘 되어야 한다.



### Aspect

**핵심 기능과 부가 기능을 분리**

부가 기능을 핵심기능에서 분리하고 한 곳에서 관리하자!!

부가 기능 + 어디에 적용할지 선택하는 기능 = 애스팩트(aspect)

**AOP(Aspect-Oriented Programming)**



**AspectJ 프레임워크**

AOP의 대표적인 구현으로, 스프링은 대부분 AspectJ의 문법을 차용하고, 기능의 일부만 제공한다.



### 적용 방식

AOP를 사용하면 핵심 기능과 부가 기능이 코드상 완전히 분리되어서 관리된다. AOP를 사용할 때 부가 기능 로직은 어떤 방식으로 실제 로직에 추가될 수 있을까?

1. 컴파일 시점
2. 클래스 로딩 시점
3. 런타임 시점(프록시)



**컴파일 시점**

AspectJ가 제공하는 컴파일러를 사용해서 `.class` 를 만드는 시점에 부가 기능 로직을 추가한다. 해당 컴파일러는 Aspect를 확인해서 해당 클래스가 적용 대상인지 확인하고 부가 기능 로직을 적용한다.

원본 로직에 부가 기능 로직이 추가되는 것을 위빙(Weaving) 이라고 함.

단점: 컴파일 시점에 부가 기능을 적용하려면 특별한 컴파일러도 필요하고 복잡하다.

그래서 잘 안씀



**클래스 로딩 시점**

자바를 실행하면 `.class` 파일을 JVM 내부의 클래스 로더에 보관하는데, 이때 중간에서 `.class` 파일을 조작한 다음 JVM에 올린다.

단점: 로드 타임 위빙은 자바를 실행할 때 특별한 옵션(`java -javaagent`)을 통해 클래스 로더 조작기를 지정해야 하는데, 이 부분이 번거롭고 운영하기 어렵다.



**런타임 시점**

자바의 `main()` 메서드 실행된 다음! 프록시를 통해 부가 기능 적용. 이때까지 한거.

프록시를 사용하기 때문에 AOP 기능에 일부 제약이 있다. 대신 간단하다. 스프링 AOP가 사용하는 방식.



**AOP 적용 위치**

- 적용 가능 지점(join Point): 생성자, 필드 값 접근, static 메서드 접근, 메서드 실행
- 프록시 방식을 사용하는 스프링 AOP는 메서드 실행 지점에만 AOP 적용 가능
  - 프록시는 메서드 오버라이딩 개념으로 동작하기 때문
  - 따라서 프록시를 사용하는 스프링 AOP의 조인 포인트는 메서드 실행으로 제한
- 스프링 AOP는 스프링 컨테이너가 관리하는 스프링 빈에만 AOP 적용 가능



### 용어 정리

**조인 포인트 (join point)**

- AOP를 적용할 수 있는 모든 지점.
- 어드바이스가 적용될 수 있는 위치, 메서드 실행, 생성자 호출, 필드 값 접근 등등.. 
- 스프링 AOP는 항상 메서드 실행 지점으로 제한됨



**포인트컷(Pointcut)**

- 조인 포인트 중에서 어드바이스가 적용될 위치를 선별하는 기능
- 주로 AspectJ 표현식 사용해서 지정
- 프록시를 사용하는 스프링 AOP 는 메서드 실행 지점만 포인트컷으로 선별 가능



**타겟(Target)**

- 포인트컷으로 결정되는 어드바이스를 받는 객체



**어드바이스(Advice)**

- 부가 기능
- 특정 조인 포인트에서 Aspect에 의해 취해지는 조치
- Around, Before, After와 같은 다양한 종류의 어드바이스가 있음



**애스펙트(Aspect)**

- 어드바이스 + 포인트컷을 모듈화 한 것
- `@Aspect`
- 여러 어드바이스와 포인트 컷이 함께 존재



**어드바이저**

- 어드바이스 + 포인트 컷



**위빙(Weaving)**

- 포인트컷으로 결정한 타겟의 조인 포인트에 어드바이스르 적용하는 것
- 위빙을 통해 핵심 기능 코드에 영향을 주지 않고 부가 기능 추가 가능



**AOP 프록시**

- AOP 기능 구현을 위해 만든 프록시 객체. 스프링에서의 AOP 프록시는 JDK 동적 프록시 또는 CGLIB 프록시