프로젝트 설정..

package 구조 

- hello.login 
- domain 
  - item 
  - member 
  - login 
- web 
  - item 
  - member 
  - login



**도메인이 가장 중요하다!!**

도메인 = 화면, UI, 기술 인프라 등의 영역을 제외한 **시스템이 구현해야 하는 핵심 비즈니스 업무 영역**

패키지를 domain / web으로 나누었는데, 향후 web을 다른 기술로 바꾸어도 도메인은 그대로 유지할 수 있어야 한다.

이렇게 하려면 web은 domain을 알고 있지만, domain은 web을 모르도록 설계해야 한다. (web은 domain에 의존, domain은 web에 의존 X)



로그인 상태를 유지하면서, 로그인에 성공한 사용자는 홈 화면 접근 시 이름을 보여주려면 어떻게 해야 할까??



## 로그인 처리 - 쿠키 사용

로그인의 상태를 쿠키를 사용해서 처리해보자.

로그인에 성공하면, 서버에서 HTTP 응답에 쿠키를 담아서 브라우저에 전달하자. 그러면 브라우저는 앞으로 해당 쿠키를 요청 시에 계속 보내준다.



쿠키의 종류

- 영속 쿠키: 만료 날짜를 입력하면 해당 날짜까지 유지
- 세션 쿠키: 만료 날짜를 생략하면 브라우저 종료시까지만 유지



``` java
		Cookie idCookie = new Cookie("memberId", String.valueOf(loginMember.getId()));
    response.addCookie(idCookie);
```

로그인에 성공하면 쿠키를 생성하고 `HttpServletResponse`에 담는다. 쿠키 이름은 `memberId`이고, 값은 회원의 `id`를 담아둔다. 만료 날짜를 생략했으므로 세션 쿠키이고, 웹 브라우저 종료 전까지 회원의 `id`를 서버에 계속 보내줄 것.



```java
@GetMapping("/")
public String homeLogin(@CookieValue(name = "memberId", required = false) Long memberId, Model model) {
    if (memberId == null) {
        return "home";
    }

    // 로그인
    Member loginMember = memberRepository.findById(memberId);
    if (loginMember == null) {
        return "home";
    }

    model.addAttribute("member", loginMember);

    return "loginHome";
}
```

- `@CookieValue`: 스프링에서 제공. 편리하게 쿠키 조회 가능
- 로그인 하지 않은 사용자도 접근할 수 있기 때문에 `required = false`



### 로그아웃

로그아웃(쿠키 삭제) 방법

- 세션 쿠키이므로 웹 브라우저 종료시
- 서버에서 해당 쿠키의 종료 날짜를 0으로 지정
  - `Set-Cookie: memberId=; Max-Age=0; Expires=Thu, 01-Jan-1970 00:00:10 GMT`



## 쿠키와 보안 문제

쿠키르 사용해서 loginId를 전달해서 로그인을 유지할 수 있지만, 심각한 보안 문제가 있다. 이렇게 개발하면 큰일난다!!



### 보안 문제

- 쿠키 값은 임의로 변경 가능
  - 클라이언트가 쿠키 변경하면 다른 사용자로 인식됨
- 쿠키에 보관된 정보는 훔쳐갈 수 있다.
  - 쿠키에 개인정보가 있다면??
  - 이 정보가 웹 브라우저에도 보관되고, 네트워크 요청마다 서버로 전송된다.
- 해커가 쿠키를 한 번 훔쳐가면 평생 사용 가능



### 대안

- 쿠키에 중요한 값 노출 X, 예측 불가능한 임의의 토큰(랜덤값)을 노출하고, 서버에서는 토큰과 사용자 id를 매핑해서 인식. 토큰은 예측 불가능한 값이어야 한다.
- 해커가 토큰을 털어가도 시간이 지나면 사용할 수 없도록 해당 토큰의 만료시간을 짧게 가져간다.



## 로그인 처리 - 세션 동작 방식

위의 보안 이슈를 해결하려면 결국 중요한 정보는 모두 **서버**에 저장해야 한다.!!

서버에 중요한 정보를 보관하고, 연결을 유지하는 방법을 세션으로 처리



- 서버에 세션 저장소 생성 및 관리

- 임의의 토큰값 (UUID는 추정 불가능하기 때문에 얘쓰면 좋다. 세션 ID)를 생성.
- 생성된 세션 ID와 세션에 보관할 값(`memberA`)을 서버의 세션 저장소에 보관
- **클라이언트 - 서버는 결국 쿠키로 연결되어야 한다.**
  - 서버는 클라이언트에 세션ID를 쿠키에 담아서 전달

- 클라이언트가 세션ID를 전달하면 서버에서는 세션 저장소에서 해당하는 세션 정보를 찾아서 사용



중요한 포인트는 회원과 관련된 정보는 클라이언트에 전혀 전달하지 않는다.

추정 불가능한 세션 ID만 쿠키를 통해 클라이언트에 전달한다.



## 로그인 처리 - 세션 직접 만들기

세션 관리는 크게 세 가지 기능을 제공하면 된다.

- 세션 생성
  - sessionId 생성
  - 세션 저장소에 sessionId와 보관할 값 저장
  - sessionId로 응답 쿠키를 생성해서 클라이언트에 전달
- 세션 조회
- 세션 만료



## 로그인 처리 - 직접 만든 세션 적용









## 로그인 처리 - 서블릿 HTTP 세션









## 세션 정보와 타임아웃 설정





